cmake_minimum_required(VERSION 2.8)

project(libeternity)

# options
option(USE_OPENGL "Build the OpenGL renderer" ON)

# general setup
link_directories("${CMAKE_BINARY_DIR}")
link_directories("${CMAKE_SOURCE_DIR}/Source/ThirdParty/clang/lib")
link_directories("${CMAKE_SOURCE_DIR}/Source/ThirdParty/glfw/lib")
link_directories("${CMAKE_SOURCE_DIR}/Source/ThirdParty/v8/lib")
link_directories("${CMAKE_SOURCE_DIR}/Source/ThirdParty/soil/lib")

# set the output directory without the /Debug/ and /Release/ equivalents
foreach( OUTPUTCONFIG ${CMAKE_CONFIGURATION_TYPES} )
    string( TOUPPER ${OUTPUTCONFIG} OUTPUTCONFIG )
    set( CMAKE_RUNTIME_OUTPUT_DIRECTORY_${OUTPUTCONFIG} ${CMAKE_BINARY_DIR} )
    set( CMAKE_LIBRARY_OUTPUT_DIRECTORY_${OUTPUTCONFIG} ${CMAKE_BINARY_DIR} )
    set( CMAKE_ARCHIVE_OUTPUT_DIRECTORY_${OUTPUTCONFIG} ${CMAKE_BINARY_DIR} )
endforeach( OUTPUTCONFIG CMAKE_CONFIGURATION_TYPES )

# create metacode output directory
file(MAKE_DIRECTORY "${CMAKE_SOURCE_DIR}/Source/Autogenerated")

# create stub file
file(WRITE "${CMAKE_SOURCE_DIR}/Source/Autogenerated/Metadata.cpp" "// Autogenerated stub file")

# metacode generator
set (GENERATOR_LIBS "")
list (APPEND GENERATOR_LIBS "libclang.lib")

set (GENERATOR_INCLUDE_DIRS "")
list (APPEND GENERATOR_INCLUDE_DIRS "Source/Generator")
list (APPEND GENERATOR_INCLUDE_DIRS "Source/ThirdParty/clang/include")

add_executable(generator Source/Generator/main.cpp Source/Generator/Directory.cpp)

target_include_directories(generator PRIVATE ${GENERATOR_INCLUDE_DIRS})
target_link_libraries(generator ${GENERATOR_LIBS})

# create the execution as a custom target
add_custom_target(
	generator-prebuild
	COMMAND ${CMAKE_BINARY_DIR}/generator.exe "${CMAKE_SOURCE_DIR}/Source/Workspace/eternity"
)

# main eternity library
set (ETERNITY_SOURCE_FILES "")

macro (list_source_files dir)
	file (GLOB CPP_FILES "${dir}/*.cpp")
	file (GLOB H_FILES "${dir}/*.h")
	
	list (APPEND ETERNITY_SOURCE_FILES ${CPP_FILES})
	list (APPEND ETERNITY_SOURCE_FILES ${H_FILES})
endmacro()

list_source_files("Source/Engine/Core")
list_source_files("Source/Engine/IO")
list_source_files("Source/Engine/Network")
list_source_files("Source/Engine/Render")
list_source_files("Source/Engine/Render/DeferredRenderer")
IF(USE_OPENGL)
	list_source_files("Source/Engine/Render/OpenGL")
ENDIF()
list_source_files("Source/Engine/Scripting")

set (ETERNITY_INCLUDE_DIRS "")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/Engine")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/ThirdParty/v8/include")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/ThirdParty/glfw/include")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/ThirdParty/glm/include")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/ThirdParty/glew/include")
list (APPEND ETERNITY_INCLUDE_DIRS "Source/ThirdParty/soil/include")

set (ETERNITY_LIBS "")
list (APPEND ETERNITY_LIBS "glfw3")
list (APPEND ETERNITY_LIBS "icui18n")
list (APPEND ETERNITY_LIBS "icuuc")
list (APPEND ETERNITY_LIBS "v8_base_0")
list (APPEND ETERNITY_LIBS "v8_base_1")
list (APPEND ETERNITY_LIBS "v8_base_2")
list (APPEND ETERNITY_LIBS "v8_base_3")
list (APPEND ETERNITY_LIBS "v8_libbase")
list (APPEND ETERNITY_LIBS "v8_libplatform")
list (APPEND ETERNITY_LIBS "v8_libsampler")
list (APPEND ETERNITY_LIBS "v8_external_snapshot")
list (APPEND ETERNITY_LIBS "SOIL")

IF(WIN32)
	list (APPEND ETERNITY_LIBS "legacy_stdio_definitions.lib")
	list (APPEND ETERNITY_LIBS "OpenGL32.lib")
	list (APPEND ETERNITY_LIBS "WS2_32.lib")
	list (APPEND ETERNITY_LIBS "WinMM.Lib")
	list (APPEND ETERNITY_LIBS "AdvAPI32.Lib")
	list (APPEND ETERNITY_LIBS "Crypt32.Lib")
	list (APPEND ETERNITY_LIBS "Dbghelp.lib")
	list (APPEND ETERNITY_LIBS "ShLwApi.Lib")
ENDIF()

IF(APPLE)
	list (APPEND ETERNITY_LIBS "-framework IOKit")
ENDIF()

add_library(eternity STATIC ${ETERNITY_SOURCE_FILES} Source/ThirdParty/glew/src/glew.c Source/Autogenerated/Metadata.cpp)

set_property(TARGET eternity APPEND PROPERTY COMPILE_DEFINITIONS "GIGA_API=")
set_property(TARGET eternity APPEND PROPERTY COMPILE_DEFINITIONS "GLEW_STATIC")
set_property(TARGET eternity APPEND PROPERTY COMPILE_DEFINITIONS "_CRT_SECURE_NO_WARNINGS")

target_link_libraries(eternity ${ETERNITY_LIBS})
target_include_directories(eternity PRIVATE ${ETERNITY_INCLUDE_DIRS})

add_dependencies(eternity generator-prebuild)

# game client
add_executable(game Source/Game/main.cpp)

set_property(TARGET game APPEND PROPERTY COMPILE_DEFINITIONS "GIGA_API=")
set_property(TARGET game APPEND PROPERTY COMPILE_DEFINITIONS "GLEW_STATIC")
set_property(TARGET game APPEND PROPERTY COMPILE_DEFINITIONS "_CRT_SECURE_NO_WARNINGS")

target_link_libraries(game "eternity" ${ETERNITY_LIBS})
target_include_directories(game PRIVATE ${ETERNITY_INCLUDE_DIRS})
add_dependencies(game eternity)
